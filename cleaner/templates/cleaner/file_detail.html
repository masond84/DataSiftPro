{% extends 'cleaner/base.html' %}
{% load static %}

{% block head_extra %}
    <title>{{file.upload.name}}</title>
    <!-- Link to stylesheet -->
    <link rel="stylesheet" type="text/css" href="{% static 'cleaner/css/file_detail_styles.css' %}">
    <!-- Link to Handsontable library -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable@10.0.0/dist/handsontable.full.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@10.0.0/dist/handsontable.full.min.js"></script>
    <!--
    <style>
        .table-wrapper {
            display: flex; /* Enable flexbox layout */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            width: 100%; /* Full width */
            height: 500px; /* Set a fixed height or adjust as needed */
        }
    </style>-->
{% endblock %}

{% block content %}
    <div id="content-container">
        <!-- Jumbotron -->
        <div class="jumbotron" style="height: 80px;display: flex;flex-direction: column;justify-content: center;">
            <h1 class="display-4" style="font-family: 'Montserrat'; font-weight: bold; font-size: 1.5rem; text-align: center;">{{ file.name|default:file_name }}</h1>
            <p class="lead" style="font-size: 1rem; text-align: cfenter;">View and Manipulate Your File Below</p>
            
            <div class="btn-container">
                <!-- Rename Button -->
                <a class="btn btn-primary" href="{% url 'cleaner:rename_file' pk=file.pk %}">Rename</a>
                <!-- Download button -->
                <a href="{% url 'cleaner:download_files' file_name=file_path %}" class="btn btn-primary">Download Excel File</a>
                <!-- Save Button -->
                <a href="{% url 'cleaner:save_file_content' %}" id="saveButton" class="btn btn-success">Save Changes</a>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-wrapper">
            <div id="hot">{{ df | escapejs }}</div>
            
        </div>
    </div>
    <script>
        
        var data = JSON.parse('{{ df |escapejs }}');
        var headers = data[0]
        console.log(headers)
        var actualData = data.slice(1)

        var container = document.getElementById('hot');
        var hot = new Handsontable(container, {
          data: actualData,
          rowHeaders: true,
          colHeaders: headers,
          filters: true,
          dropdownMenu: true,
          contextMenu: ['row_above', 'row_below', 'col_left', 'col_right', 'remove_row', 'remove_col']
        });

        document.getElementById("saveButton").addEventListener("click", function(event) {
            event.preventDefault(); // Prevent the default action of the anchor tag
            
            var updatedData = hot.getData();
            console.log(updatedData)

            var headers = hot.getColHeader();
            var dataToSend = {
                'headers': headers,
                'updated_data': JSON.stringify(updatedData),
                'file_pk': '{{ file.pk }}'
            };
        
            // Use AJAX to send data to server
            fetch('{% url "cleaner:save_file_content" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);  // Display the returned message in an alert.
                if(data.success) {
                    location.reload();  // Refresh the page to display updated content.
                }
            });
        });
    </script>
{% endblock %}